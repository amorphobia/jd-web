(function(){"use strict";function v(e,n){self.onmessage=async t=>{await n;const{name:s,args:r,transferableIndices:i}=t.data,o=[];let c;try{const a=e[s];if(typeof a!="function"){console.error(`${s} is not an exposed worker function`),self.close();return}const u=await a(...r);r.forEach((l,M)=>i.includes(M)&&o.push(l)),c={type:"success",result:u,transferables:o}}catch(a){const{message:u,name:l}=a;c={type:"error",error:{message:u,name:l}}}self.postMessage(c,o)}}function O(e){return(...n)=>{const t={type:"control",name:e,args:n};self.postMessage(t)}}function $(e,n){n=n||{};const{url:t,init:s}=n;return new Promise(r=>{self.Module={onRuntimeInitialized(){s&&s(),r(null)},locateFile(i,o){return(t||o)+i}},importScripts((t||"")+e)})}function F(e,...n){const t=Module.FS[e](...n);if(e!=="mkdir")return t}const T=(e,n)=>n.some(t=>e instanceof t);let I,j;function A(){return I||(I=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function _(){return j||(j=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const B=new WeakMap,f=new WeakMap,E=new WeakMap,m=new WeakMap,h=new WeakMap;function V(e){const n=new Promise((t,s)=>{const r=()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},i=()=>{t(d(e.result)),r()},o=()=>{s(e.error),r()};e.addEventListener("success",i),e.addEventListener("error",o)});return n.then(t=>{t instanceof IDBCursor&&B.set(t,e)}).catch(()=>{}),h.set(n,e),n}function x(e){if(f.has(e))return;const n=new Promise((t,s)=>{const r=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},i=()=>{t(),r()},o=()=>{s(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)});f.set(e,n)}let p={get(e,n,t){if(e instanceof IDBTransaction){if(n==="done")return f.get(e);if(n==="objectStoreNames")return e.objectStoreNames||E.get(e);if(n==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return d(e[n])},set(e,n,t){return e[n]=t,!0},has(e,n){return e instanceof IDBTransaction&&(n==="done"||n==="store")?!0:n in e}};function N(e){p=e(p)}function W(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(n,...t){const s=e.call(b(this),n,...t);return E.set(s,n.sort?n.sort():[n]),d(s)}:_().includes(e)?function(...n){return e.apply(b(this),n),d(B.get(this))}:function(...n){return d(e.apply(b(this),n))}}function k(e){return typeof e=="function"?W(e):(e instanceof IDBTransaction&&x(e),T(e,A())?new Proxy(e,p):e)}function d(e){if(e instanceof IDBRequest)return V(e);if(m.has(e))return m.get(e);const n=k(e);return n!==e&&(m.set(e,n),h.set(n,e)),n}const b=e=>h.get(e);function H(e,n,{blocked:t,upgrade:s,blocking:r,terminated:i}={}){const o=indexedDB.open(e,n),c=d(o);return s&&o.addEventListener("upgradeneeded",a=>{s(d(o.result),a.oldVersion,a.newVersion,d(o.transaction),a)}),t&&o.addEventListener("blocked",a=>t(a.oldVersion,a.newVersion,a)),c.then(a=>{i&&a.addEventListener("close",()=>i()),r&&a.addEventListener("versionchange",u=>r(u.oldVersion,u.newVersion,u))}).catch(()=>{}),c}const R=["get","getKey","getAll","getAllKeys","count"],z=["put","add","delete","clear"],y=new Map;function S(e,n){if(!(e instanceof IDBDatabase&&!(n in e)&&typeof n=="string"))return;if(y.get(n))return y.get(n);const t=n.replace(/FromIndex$/,""),s=n!==t,r=z.includes(t);if(!(t in(s?IDBIndex:IDBObjectStore).prototype)||!(r||R.includes(t)))return;const i=async function(o,...c){const a=this.transaction(o,r?"readwrite":"readonly");let u=a.store;return s&&(u=u.index(c.shift())),(await Promise.all([u[t](...c),r&&a.done]))[0]};return y.set(n,i),i}N(e=>({...e,get:(n,t,s)=>S(n,t)||e.get(n,t,s),has:(n,t)=>!!S(n,t)||e.has(n,t)}));const w="hash",g="content";class K{dbPromise;constructor(n){this.dbPromise=H(n,1,{upgrade(t){t.createObjectStore(w),t.createObjectStore(g)}})}async getDB(){return this.dbPromise.catch(()=>{})}async get(n,t,s){const r=await this.getDB();if(await r?.get(w,n)===t)return r.get(g,n);const o=await fetch(s);if(!o.ok)throw new Error(`Fail to download ${n}`);const c=await o.arrayBuffer();return await r?.put(g,c,n),await r?.put(w,t,n),c}}var U="\u{1F31F}\uFE0F\u661F\u7A7A\u952E\u9053",G={jiandao:U},J={},Q={jiandao:J},X="amorphobia/rime-jiandao@release",Y={jiandao:X},Z=[],q={jiandao:Z},ee={"amorphobia/rime-jiandao@release":[{name:"jiandao.prism.bin",md5:"be5181cf008b09c3012d0ef221f43bbb"},{name:"jiandao.reverse.bin",md5:"7aa2454aafd01e28a39bcd665c7501cd"},{name:"jiandao.schema.yaml",md5:"26397116d89bcc0e2a76dd3b72a20687"},{name:"jiandao.table.bin",md5:"7aed029bc3bc875a90c213c1da81b418"}]};function ne(e,n){return`ime/${e}/${n}`}const te=new K("ime");async function re(e){const n=[];function t(r){if(n.includes(r))return[];n.push(r);const i=[];for(const D of q[r]||[])i.push(...t(D));const{dict:o,prism:c}=Q[r],a=o||r,u=`${a}.table.bin`,l=`${a}.reverse.bin`,M=`${c||a}.prism.bin`,ie=`${r}.schema.yaml`,L=Y[r];for(const D of[u,l,M,ie])for(const{name:C,md5:ce}of ee[L])if(D===C){i.push({name:C,md5:ce,target:L});break}return i}const s=t(e);await Promise.all(s.map(async({name:r,target:i,md5:o})=>{const c=`build/${r}`;try{Module.FS.lookupPath(c)}catch{const a=await te.get(r,o,ne(i,r));Module.FS.writeFile(c,new Uint8Array(a))}}))}async function oe(e){P||await re(e),Module.ccall("set_ime","null",["string"],[e])}const se=$("rime.js",{url:"",init(){Module.FS.chdir("rime"),Module.ccall("init","null",[],[]);for(const[e,n]of Object.entries(G))Module.ccall("set_schema_name","null",["string","string"],[e,n])}});let P=!1;const ae=O("deployStatus");globalThis._deployStatus=(e,n)=>{e==="success"&&(P=!0),ae(e,n)},v({fsOperate:F,setIME:oe,setOption(e,n){return Module.ccall("set_option","null",["string","number"],[e,n])},deploy(){return Module.ccall("deploy","null",[],[])},process(e){return Module.ccall("process","string",["string"],[e])},selectCandidateOnCurrentPage(e){return Module.ccall("select_candidate_on_current_page","string",["number"],[e])}},se)})();
