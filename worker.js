(function(){"use strict";function L(e,t){self.onmessage=async n=>{await t;const{name:s,args:r,transferableIndices:a}=n.data,o=[];let i;try{const c=e[s];if(typeof c!="function"){console.error(`${s} is not an exposed worker function`),self.close();return}const d=await c(...r);r.forEach((f,M)=>a.includes(M)&&o.push(f)),i={type:"success",result:d,transferables:o}}catch(c){const{message:d,name:f}=c;i={type:"error",error:{message:d,name:f}}}self.postMessage(i,o)}}function v(e){return(...t)=>{const n={type:"control",name:e,args:t};self.postMessage(n)}}function $(e,t){t=t||{};const{url:n,init:s}=t;return new Promise(r=>{self.Module={onRuntimeInitialized(){s&&s(),r(null)},locateFile(a,o){return(n||o)+a}},importScripts((n||"")+e)})}function C(e,...t){const n=Module.FS[e](...t);if(e!=="mkdir")return n}const F=(e,t)=>t.some(n=>e instanceof n);let D,I;function O(){return D||(D=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function T(){return I||(I=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const x=new WeakMap,l=new WeakMap,B=new WeakMap,m=new WeakMap,h=new WeakMap;function A(e){const t=new Promise((n,s)=>{const r=()=>{e.removeEventListener("success",a),e.removeEventListener("error",o)},a=()=>{n(u(e.result)),r()},o=()=>{s(e.error),r()};e.addEventListener("success",a),e.addEventListener("error",o)});return t.then(n=>{n instanceof IDBCursor&&x.set(n,e)}).catch(()=>{}),h.set(t,e),t}function V(e){if(l.has(e))return;const t=new Promise((n,s)=>{const r=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",o),e.removeEventListener("abort",o)},a=()=>{n(),r()},o=()=>{s(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",a),e.addEventListener("error",o),e.addEventListener("abort",o)});l.set(e,t)}let p={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return l.get(e);if(t==="objectStoreNames")return e.objectStoreNames||B.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return u(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function N(e){p=e(p)}function W(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const s=e.call(b(this),t,...n);return B.set(s,t.sort?t.sort():[t]),u(s)}:T().includes(e)?function(...t){return e.apply(b(this),t),u(x.get(this))}:function(...t){return u(e.apply(b(this),t))}}function _(e){return typeof e=="function"?W(e):(e instanceof IDBTransaction&&V(e),F(e,O())?new Proxy(e,p):e)}function u(e){if(e instanceof IDBRequest)return A(e);if(m.has(e))return m.get(e);const t=_(e);return t!==e&&(m.set(e,t),h.set(t,e)),t}const b=e=>h.get(e);function H(e,t,{blocked:n,upgrade:s,blocking:r,terminated:a}={}){const o=indexedDB.open(e,t),i=u(o);return s&&o.addEventListener("upgradeneeded",c=>{s(u(o.result),c.oldVersion,c.newVersion,u(o.transaction),c)}),n&&o.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),i.then(c=>{a&&c.addEventListener("close",()=>a()),r&&c.addEventListener("versionchange",d=>r(d.oldVersion,d.newVersion,d))}).catch(()=>{}),i}const R=["get","getKey","getAll","getAllKeys","count"],z=["put","add","delete","clear"],y=new Map;function E(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(y.get(t))return y.get(t);const n=t.replace(/FromIndex$/,""),s=t!==n,r=z.includes(n);if(!(n in(s?IDBIndex:IDBObjectStore).prototype)||!(r||R.includes(n)))return;const a=async function(o,...i){const c=this.transaction(o,r?"readwrite":"readonly");let d=c.store;return s&&(d=d.index(i.shift())),(await Promise.all([d[n](...i),r&&c.done]))[0]};return y.set(t,a),a}N(e=>({...e,get:(t,n,s)=>E(t,n)||e.get(t,n,s),has:(t,n)=>!!E(t,n)||e.has(t,n)}));const w="hash",g="content";class K{dbPromise;constructor(t){this.dbPromise=H(t,1,{upgrade(n){n.createObjectStore(w),n.createObjectStore(g)}})}async getDB(){return this.dbPromise.catch(()=>{})}async get(t,n,s){const r=await this.getDB();if(await r?.get(w,t)===n)return r.get(g,t);const o=await fetch(s);if(!o.ok)throw new Error(`Fail to download ${t}`);const i=await o.arrayBuffer();return await r?.put(g,i,t),await r?.put(w,n,t),i}}var U="\u2B50\uFE0F\u661F\u7A7A\u952E\u9053",G={xkjd6:U},J={dict:"xkjd6.extended"},Q={xkjd6:J},X="amorphobia/jd-plum",Y={xkjd6:X},Z=[],q={xkjd6:Z},ee={"amorphobia/jd-plum":[{name:"xkjd6.extended.prism.bin",md5:"9b4862bdc13013e846cf915010917e49"},{name:"xkjd6.extended.reverse.bin",md5:"17c2dd81ac500fb8f33f2b1ac5be45c3"},{name:"xkjd6.extended.table.bin",md5:"27b4af930e4415213ee28f87fa909407"},{name:"xkjd6.schema.yaml",md5:"8617137ccaf2953400cf64f771595878"}]};function te(e,t){return`ime/${e}/${t}`}const ne=new K("ime");async function re(e){const t=[];function n(r){if(t.includes(r))return[];t.push(r);const a=[];for(const j of q[r]||[])a.push(...n(j));const{dict:o,prism:i}=Q[r],c=o||r,d=`${c}.table.bin`,f=`${c}.reverse.bin`,M=`${i||c}.prism.bin`,ae=`${r}.schema.yaml`,k=Y[r];for(const j of[d,f,M,ae])for(const{name:P,md5:ie}of ee[k])if(j===P){a.push({name:P,md5:ie,target:k});break}return a}const s=n(e);await Promise.all(s.map(async({name:r,target:a,md5:o})=>{const i=`build/${r}`;try{Module.FS.lookupPath(i)}catch{const c=await ne.get(r,o,te(a,r));Module.FS.writeFile(i,new Uint8Array(c))}}))}async function oe(e){S||await re(e),Module.ccall("set_ime","null",["string"],[e])}const se=$("rime.js",{url:"",init(){Module.FS.chdir("rime"),Module.ccall("init","null",[],[]);for(const[e,t]of Object.entries(G))Module.ccall("set_schema_name","null",["string","string"],[e,t])}});let S=!1;const ce=v("deployStatus");globalThis._deployStatus=(e,t)=>{e==="success"&&(S=!0),ce(e,t)},L({fsOperate:C,setIME:oe,setOption(e,t){return Module.ccall("set_option","null",["string","number"],[e,t])},deploy(){return Module.ccall("deploy","null",[],[])},process(e){return Module.ccall("process","string",["string"],[e])}},se)})();
