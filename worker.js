(function(){"use strict";function v(e,n){self.onmessage=async t=>{await n;const{name:o,args:r,transferableIndices:a}=t.data,s=[];let c;try{const i=e[o];if(typeof i!="function"){console.error(`${o} is not an exposed worker function`),self.close();return}const u=await i(...r);r.forEach((l,I)=>a.includes(I)&&s.push(l)),c={type:"success",result:u,transferables:s}}catch(i){const{message:u,name:l}=i;c={type:"error",error:{message:u,name:l}}}self.postMessage(c,s)}}function T(e){return(...n)=>{const t={type:"control",name:e,args:n};self.postMessage(t)}}function k(e,n){n=n||{};const{url:t,init:o}=n;return new Promise(r=>{self.Module={async onRuntimeInitialized(){o&&await o(),r(null)},locateFile(a,s){return(t||s)+a}},importScripts((t||"")+e)})}function A(e,...n){const t=Module.FS[e](...n);if(e!=="mkdir")return t}const _=(e,n)=>n.some(t=>e instanceof t);let B,E;function N(){return B||(B=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function V(){return E||(E=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const F=new WeakMap,f=new WeakMap,P=new WeakMap,m=new WeakMap,h=new WeakMap;function x(e){const n=new Promise((t,o)=>{const r=()=>{e.removeEventListener("success",a),e.removeEventListener("error",s)},a=()=>{t(d(e.result)),r()},s=()=>{o(e.error),r()};e.addEventListener("success",a),e.addEventListener("error",s)});return n.then(t=>{t instanceof IDBCursor&&F.set(t,e)}).catch(()=>{}),h.set(n,e),n}function W(e){if(f.has(e))return;const n=new Promise((t,o)=>{const r=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",s),e.removeEventListener("abort",s)},a=()=>{t(),r()},s=()=>{o(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",a),e.addEventListener("error",s),e.addEventListener("abort",s)});f.set(e,n)}let p={get(e,n,t){if(e instanceof IDBTransaction){if(n==="done")return f.get(e);if(n==="objectStoreNames")return e.objectStoreNames||P.get(e);if(n==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return d(e[n])},set(e,n,t){return e[n]=t,!0},has(e,n){return e instanceof IDBTransaction&&(n==="done"||n==="store")?!0:n in e}};function R(e){p=e(p)}function H(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(n,...t){const o=e.call(b(this),n,...t);return P.set(o,n.sort?n.sort():[n]),d(o)}:V().includes(e)?function(...n){return e.apply(b(this),n),d(F.get(this))}:function(...n){return d(e.apply(b(this),n))}}function K(e){return typeof e=="function"?H(e):(e instanceof IDBTransaction&&W(e),_(e,N())?new Proxy(e,p):e)}function d(e){if(e instanceof IDBRequest)return x(e);if(m.has(e))return m.get(e);const n=K(e);return n!==e&&(m.set(e,n),h.set(n,e)),n}const b=e=>h.get(e);function U(e,n,{blocked:t,upgrade:o,blocking:r,terminated:a}={}){const s=indexedDB.open(e,n),c=d(s);return o&&s.addEventListener("upgradeneeded",i=>{o(d(s.result),i.oldVersion,i.newVersion,d(s.transaction),i)}),t&&s.addEventListener("blocked",i=>t(i.oldVersion,i.newVersion,i)),c.then(i=>{a&&i.addEventListener("close",()=>a()),r&&i.addEventListener("versionchange",u=>r(u.oldVersion,u.newVersion,u))}).catch(()=>{}),c}const z=["get","getKey","getAll","getAllKeys","count"],J=["put","add","delete","clear"],y=new Map;function L(e,n){if(!(e instanceof IDBDatabase&&!(n in e)&&typeof n=="string"))return;if(y.get(n))return y.get(n);const t=n.replace(/FromIndex$/,""),o=n!==t,r=J.includes(t);if(!(t in(o?IDBIndex:IDBObjectStore).prototype)||!(r||z.includes(t)))return;const a=async function(s,...c){const i=this.transaction(s,r?"readwrite":"readonly");let u=i.store;return o&&(u=u.index(c.shift())),(await Promise.all([u[t](...c),r&&i.done]))[0]};return y.set(n,a),a}R(e=>({...e,get:(n,t,o)=>L(n,t)||e.get(n,t,o),has:(n,t)=>!!L(n,t)||e.has(n,t)}));const w="hash",M="content";class G{dbPromise;constructor(n){this.dbPromise=U(n,1,{upgrade(t){t.createObjectStore(w),t.createObjectStore(M)}})}async getDB(){return this.dbPromise.catch(()=>{})}async get(n,t,o){const r=await this.getDB();if(await r?.get(w,n)===t)return r.get(M,n);const s=await fetch(o);if(!s.ok)throw new Error(`Fail to download ${n}`);const c=await s.arrayBuffer();return await r?.put(M,c,n),await r?.put(w,t,n),c}}var Q="\u{1F31F}\uFE0F\u661F\u7A7A\u952E\u9053",X={jiandao:Q},Y={},Z={jiandao:Y},q="amorphobia/rime-jiandao",ee={jiandao:q},ne=[],te={jiandao:ne},re={"amorphobia/rime-jiandao":[{name:"jiandao.prism.bin",md5:"05108d12dbfcaf4ffb434682de132e1a"},{name:"jiandao.reverse.bin",md5:"daee4f46f24552675c91c1b64174acf9"},{name:"jiandao.schema.yaml",md5:"26397116d89bcc0e2a76dd3b72a20687"},{name:"jiandao.table.bin",md5:"9ce73d56c127254caa00e852474be985"}]};const g="/rime",oe="/usr/share/rime-data";function se(e,n){return`ime/${e}/${n}`}const ae=new G("ime");async function ie(e){const n=[];function t(r){if(n.includes(r))return[];n.push(r);const a=[];for(const j of te[r]||[])a.push(...t(j));const{dict:s,prism:c}=Z[r],i=s||r,u=`${i}.table.bin`,l=`${i}.reverse.bin`,I=`${c||i}.prism.bin`,fe=`${r}.schema.yaml`,C=ee[r];for(const j of[u,l,I,fe])for(const{name:O,md5:me}of re[C])if(j===O){a.push({name:O,md5:me,target:C});break}return a}const o=t(e);await Promise.all(o.map(async({name:r,target:a,md5:s})=>{const c=`${oe}/build/${r}`;try{Module.FS.lookupPath(c)}catch{const i=await ae.get(r,s,se(a,r));Module.FS.writeFile(c,new Uint8Array(i))}}))}async function ce(e){S||await ie(e),Module.ccall("set_ime","null",["string"],[e])}function D(e){let n,t;const o=new Promise((r,a)=>{n=r,t=a});return Module.FS.syncfs(e==="read",r=>{r&&t(r),n(null)}),o}const ue=k("rime.js",{url:"",async init(){Module.FS.mkdir(g),Module.FS.mount(IDBFS,{},g),await D("read"),Module.ccall("init","null",[],[]);for(const[e,n]of Object.entries(X))Module.ccall("set_schema_name","null",["string","string"],[e,n])}});let S=!1;const de=T("deployStatus");globalThis._deployStatus=(e,n)=>{e==="success"&&(S=!0),de(e,n)};function $(e){for(const n of Module.FS.readdir(e)){if(n==="."||n==="..")continue;const t=`${e}/${n}`,{mode:o}=Module.FS.lstat(t);Module.FS.isDir(o)?($(t),Module.FS.rmdir(t)):Module.FS.unlink(t)}}async function le(){$(g),await D("write"),S=!1}v({fsOperate:A,resetUserDirectory:le,setIME:ce,setOption(e,n){return Module.ccall("set_option","null",["string","number"],[e,n])},deploy(){return Module.ccall("deploy","null",[],[])},async process(e){const n=JSON.parse(Module.ccall("process","string",["string"],[e]));return"committed"in n&&await D("write"),n},selectCandidateOnCurrentPage(e){return Module.ccall("select_candidate_on_current_page","string",["number"],[e])}},ue)})();
